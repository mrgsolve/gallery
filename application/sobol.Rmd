---
title: Sobol sensitivity analysis
author: "Kyle Baron and Ahmed Elmokadem"
date: "`r Sys.time()`"
output:
  github_document:
    toc: TRUE
---

```{r, echo = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, 
                      comment = '.', fig.path = "img/sobol")
```


# Reference / About
Zhang XY, Trame MN, Lesko LJ, Schmidt S. __Sobol Sensitivity Analysis: A Tool to
Guide the Development and Evaluation of Systems Pharmacology Models__. CPT
Pharmacometrics Syst Pharmacol. 2015 Feb;4(2):69-79. doi: 10.1002/psp4.6. PubMed 
PMID: [27548289](https://www.ncbi.nlm.nih.gov/pubmed/27548289)

This example replicates an analysis presented in the Zhang et al. paper, 
but here using mrgsolve and other tools available for R.


# Tools
```{r}
library(mrgsolve)
library(tidyverse)
library(PKPDmisc)
library(sensitivity)
```



# The sunitinib PK model
```{r}
mod <- mread("sunit", "model") %>% 
  update(end = 24, delta = 1) %>% zero_re
```

```{r}
see(mod)
```

## Sunitinib dosing 
```{r}
sunev <- function(amt = 50,...) ev(amt = amt, ...)
```

# Generate samples

Th function generates uniform samples from a 
100 fold decrease to 100 fold increase in the 
nominal parameter value.

The return value is a list with two data frames that
can be passed into the sobol function.


```{r}
gen_samples <- function(n, l, which = names(l), 
                        factor = c(0.01,100)) {
  
  vars <- select_vars(names(l), !!(enquo(which)))
  
  l <- as.list(l)[vars]
  
  l <- lapply(l, function(x) {
    x*factor  
  })
  
  n <- length(l)*n*2
  
  df <- as.data.frame(l)
  
  len <- length(df)
  
  X <- matrix(ncol=len, nrow=n)
  
  colnames(X) <- names(df)
  
  Y <- X
  
  for(i in seq(len)){
    r <- runif(n, df[1,i], df[2,i])
    X[,i] <- r
    r <- runif(n, df[1,i], df[2,i])
    Y[,i] <- r
  }
  
  return(list(x1 = as.data.frame(X), x2 = as.data.frame(Y)))
}
```

# A bunch of helper functions

Simulate one chunk of data; not absolutely needed for 
this; but we might use it if we expand this to run in 
parallel.  I'll keep it around for now.

```{r}
sim_chunk <- function(mod, x) {
  mrgsim_ei(x = mod, ev = sunev(), idata = x, obsonly = TRUE) %>% 
    as_data_frame
}
```

Simulate a batch of data.  The summary is AUC for each individual.
```{r}
batch_run <- function(x) {
  out <- sim_chunk(mod,x)
  out <- 
    group_by(out,ID) %>% 
    summarise(AUC = auc_partial(time,CP))
  return(out$AUC)
}
```



# Run the analysis

## First, generate the samples
```{r}
samp <- gen_samples(10000, param(mod), TVCL:TVVP)
head(samp$x1)
```


## Then, run `sensitivity::soboljansen`
```{r}
x <- sobol2007(batch_run, X1=samp$x1, X2=samp$x2, nboot=100)
```

# Results

```{r}
plot(x)
```

```{r}
x
```

# Session
```{r}
devtools::session_info()
```

